<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8">
<!-- CDN -->
  <!-- jQuery -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js" integrity="sha512-894YE6QWD5I59HgZOGReFYm4dnWc1Qt5NtvYSaNcOP+u1T9qYdvdihz0PPSiiqn/+/3e7Jo4EaG7TubfWGUrMQ==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>

  <!-- Bootstrap 4 -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.0.2/js/bootstrap.min.js" integrity="sha512-a6ctI6w1kg3J4dSjknHj3aWLEbjitAXAjLDRUxo2wyYmDFRcz2RJuQr5M3Kt8O/TtUSp8n2rAyaXYy1sjoKmrQ==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.0.2/js/bootstrap.bundle.min.js" integrity="sha512-72WD92hLs7T5FAXn3vkNZflWG6pglUDDpm87TeQmfSg8KnrymL2G30R7as4FmTwhgu9H7eSzDCX3mjitSecKnw==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>  
  <!-- socketio -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.1.3/socket.io.js" integrity="sha512-PU5S6BA03fRv1Q5fpwXjg5nlRrgdoguZ74urFInkbABMCENyx5oP3hrDzYMMPh3qdLdknIvrGj3yqZ4JuU7Nag==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>

  <!-- meta -->
  <meta name="viewport" content="width=device-width, initial-scale=1">
 
<!-- style -->
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:300,400,400i,700&display=fallback">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css" integrity="sha512-iBBXm8fW90+nuLcSKlbmrPcLa0OT92xO1BIsZ+ywDWZCvqsWgccV3gFoRBv0z+8dLJgyAHIhR35VZc2oM/gI1w==" crossorigin="anonymous" referrerpolicy="no-referrer" />  
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/icheck-bootstrap/3.0.1/icheck-bootstrap.min.css" integrity="sha512-8vq2g5nHE062j3xor4XxPeZiPjmRDh6wlufQlfC6pdQ/9urJkU07NM0tEREeymP++NczacJ/Q59ul+/K2eYvcg==" crossorigin="anonymous" referrerpolicy="no-referrer" />  
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/admin-lte/3.1.0/css/adminlte.min.css" integrity="sha512-mxrUXSjrxl8vm5GwafxcqTrEwO1/oBNU25l20GODsysHReZo4uhVISzAKzaABH6/tTfAxZrY2FprmeAP5UZY8A==" crossorigin="anonymous" referrerpolicy="no-referrer" />

<!-- title -->
  <title>TEST PROJECT</title>
<script type="text/javascript" charset="utf-8">
    // 1. 사용자 정보 입력
    if(true){
      var user=prompt('성함을 입력하세요.');
      console.log('1. 사용자 정보 입력 완료');
      console.log('user: '+user);
    };
</script>
<script type="text/javascript" charset="utf-8">
    // 2. socket 연결
    if(true){
      // 2-1. url 지정
      if(true){
        var url = location.protocol+'//'+document.domain+':'+location.port;
        console.log('2-1. URL 지정 완료');
        console.log('url: '+url);
      };
      
      // 2-2. socket 인스턴스 생성
      if(true){
        var socket = io();
        console.log('2-2. socket 인스턴스 접속');
        console.log(socket);
      };

      // 2-3. user 데이터 전송
      if(true){
        socket.on('connect',()=>{
          socket.emit('login',{'user':user});
          console.log('socket 접속 성공');
          console.log('2-3. 접속자 데이터 전송 완료');
        })};      
    };
</script>
<script type="text/javascript" charset="utf-8">
    if(true){
      // 3-1. 키보드 이벤트
      if(true){
        $("[name=message]").on("keypress", (evt) => {
          if (evt.keyCode == 13) {
            var msg = encodeURI($("[name=message]").val().trim());
            socket.emit("c_msg", { user: user, msg: msg });
            $("[name=message]").val("");
          }})};

      // 3-2. send 버튼 이벤트
      if(true){
        $("#send_btn").on("click", () => {
          var msg = encodeURI($("[name=message]").val().trim());
          socket.emit("c_msg", { user: user, msg: msg });
          $("[name=message]").val("");
        })};
      };
</script>
<script>
    // 4. 메시지 수신
    if(true){
    socket.on('s_msg',(data)=>{
      // 메시지 수신 처리
      var sender = decodeURI(data.user);
      var msg = decodeURI(data.msg);
      if (sender != decodeURI(user)){
        var msghtml = `
          <div class="direct-chat-msg">
            <div class="direct-chat-infos clearfix">
              <span class="direct-chat-name float-left">${sender}</span>
            </div>
            <img class="direct-chat-img" src="static/dist/img/unknown.png" alt="message user image">
            <div class="direct-chat-text">
              ${msg}
            </div>
          </div>`
      }else{
        var msghtml = `
          <div class="direct-chat-msg right">
            <div class="direct-chat-infos clearfix">
              <span class="direct-chat-name float-right">${sender}</span>
            </div>
            <img class="direct-chat-img" src="static/dist/img/unknown.png" alt="message user image">
            <div class="direct-chat-text">
              ${msg}
            </div>
          </div>`
      };
      console.log('메시지 수신');
      console.log('sender: '+sender);
        // 수신된 메시지 화면에 출력
        $("#chatbox").append(msghtml);
        $("#scroll_area").scrollTop($("#scroll_area")[0].scrollHeight);
        console.log("출력 완료")
    });

    };
</script>


</head>

<body>



  <!-- container -->
  <div class='container-fluid col-md-12'>

    <!-- container header -->
    <div class='content_header d-flex justify-content-center'>
      <div class="login-logo">
        <!-- 버전 정의 -->

        <b style="color: brown; font-family: HANNA;">테스트 채팅룸</b></a>
      </div>    
    </div>

    <!-- card -->
    <div class="card direct-chat d-flex justify-content-center col-md-9 mx-auto">
      
      <!-- card header -->
      <div class="card-header ">
        <h3 class="card-title">Chat</h3>
        
        <!-- stop keyword button -->
        <div class="card-tools">
          <button type="button" class="btn btn-tool" title="Contacts" data-widget="chat-pane-toggle" onclick="$('#scroll_area').animate({scrollTop : 0}, 10)">
            <i class="fas fa-ban"></i>
          </button>
        </div>  
      </div>

      <!-- card body -->
      <div class="card-body" id="scroll_area" style="height: 500px;scroll-behavior:smooth">
        
        <!-- message box -->
        <div class="direct-chat-messages"  style="height: auto;">
<span id='chatbox'>
          {% for t in texts %}
        <div class="direct-chat-msg">
          <div class="direct-chat-infos clearfix">
            <span class="direct-chat-name float-left">{{t[0]}}</span>
          </div>
          <img class="direct-chat-img" src="static/dist/img/unknown.png" alt="message user image">
          <div class="direct-chat-text">
            {{t[1]}}
          </div>
        </div>
{%endfor%}
</span>

      <!-- card footer -->
      <div class="card-footer">
        <form action="#" method="post" onsubmit="return false;">
          <div class="input-group">
            <input type="text" type='hidden' name="message" placeholder="메시지를 입력하세요 ..." class="form-control">
            <input type='hidden'/>
            <span class="input-group-append">
              <button id='send_btn' type="button" class="btn btn-primary">Send</button>
            </span>
          </div>
        </form>
      </div>
    </div>

  </div>

  <script>


  // 4. 메시지 수신 처리    
    

  </script>
</body>

</html>
